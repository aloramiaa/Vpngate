name: Ultra VPN Validator

on:
  schedule:
    - cron: '0 0 * * *'  # every day at midnight
  workflow_dispatch:

jobs:
  ultra-validate:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ðŸ›  Install OpenVPN, jq, curl
        run: |
          sudo apt update
          sudo apt install -y openvpn jq curl

      - name: ðŸ” Ultra VPN Validation + JSON + Stylish README
        run: |
          mkdir -p configs/checked configs/failed

          summary_good=0
          summary_proxy=0
          summary_failed=0
          count=1

          echo "# ðŸŒ Ultra VPN Validation Report" > configs/README.md
          echo "â° Run: $(date '+%Y-%m-%d %H:%M:%S')" >> configs/README.md
          echo "" >> configs/README.md
          echo "| # | IP | ASN | Country | Provider | Threat Score | Status |" >> configs/README.md
          echo "|---|----|-----|---------|----------|--------------|--------|" >> configs/README.md

          echo "[" > configs/report.json

          for ovpn in configs/*.ovpn; do
            echo "ðŸ” Testing $ovpn"
            sudo timeout 25s openvpn --config "$ovpn" --daemon
            sleep 8

            ip=$(curl -s https://api.ipify.org?format=json | jq -r .ip || true)
            sudo pkill openvpn || true

            if [[ -z "$ip" || "$ip" == "null" ]]; then
              echo "âŒ No IP. VPN likely failed."
              mv "$ovpn" configs/failed/
              echo "| $count | n/a | n/a | ðŸš« | n/a | n/a | âŒ Failed |" >> configs/README.md
              echo "{ \"ip\": \"n/a\", \"status\": \"failed\" }," >> configs/report.json
              summary_failed=$((summary_failed+1))
              count=$((count+1))
              continue
            fi

            check=$(curl -s "http://proxycheck.io/v2/$ip?key=896357-7r961n-0t9072-j922c6&vpn=1&asn=1&node=1&inf=1&risk=1")
            proxy=$(echo "$check" | jq -r ".\"$ip\".proxy")
            asn=$(echo "$check" | jq -r ".\"$ip\".asn")
            country=$(echo "$check" | jq -r ".\"$ip\".isocode")
            provider=$(echo "$check" | jq -r ".\"$ip\".provider")
            risk=$(echo "$check" | jq -r ".\"$ip\".risk")

            [[ "$risk" == "null" ]] && risk="0"

            # More flags
            flag="ðŸŒŽ"
            case "$country" in
              US) flag="ðŸ‡ºðŸ‡¸";;
              JP) flag="ðŸ‡¯ðŸ‡µ";;
              IN) flag="ðŸ‡®ðŸ‡³";;
              DE) flag="ðŸ‡©ðŸ‡ª";;
              RU) flag="ðŸ‡·ðŸ‡º";;
              CN) flag="ðŸ‡¨ðŸ‡³";;
              GB) flag="ðŸ‡¬ðŸ‡§";;
              FR) flag="ðŸ‡«ðŸ‡·";;
              IT) flag="ðŸ‡®ðŸ‡¹";;
              ES) flag="ðŸ‡ªðŸ‡¸";;
              PL) flag="ðŸ‡µðŸ‡±";;
              NL) flag="ðŸ‡³ðŸ‡±";;
              CA) flag="ðŸ‡¨ðŸ‡¦";;
            esac

            if [[ "$proxy" == "no" ]]; then
              echo "âœ… $ip clean. Risk $risk"
              mv "$ovpn" configs/checked/
              echo "| $count | [$ip](https://ipinfo.io/$ip) | $asn | $flag $country | $provider | ðŸ”¥ $risk | âœ… Safe |" >> configs/README.md
              echo "{ \"ip\": \"$ip\", \"asn\": \"$asn\", \"country\": \"$country\", \"provider\": \"$provider\", \"risk\": \"$risk\", \"status\": \"safe\" }," >> configs/report.json
              summary_good=$((summary_good+1))
            else
              echo "ðŸš« $ip flagged proxy. Risk $risk"
              mv "$ovpn" configs/failed/
              echo "| $count | [$ip](https://ipinfo.io/$ip) | $asn | $flag $country | $provider | ðŸš© $risk | ðŸš« Proxy |" >> configs/README.md
              echo "{ \"ip\": \"$ip\", \"asn\": \"$asn\", \"country\": \"$country\", \"provider\": \"$provider\", \"risk\": \"$risk\", \"status\": \"proxy\" }," >> configs/report.json
              summary_proxy=$((summary_proxy+1))
            fi
            count=$((count+1))
            sleep 2
          done

          # JSON fix trailing comma
          sed -i '$ s/,$//' configs/report.json
          echo "]" >> configs/report.json

          echo "" >> configs/README.md
          echo "## ðŸ“ Summary" >> configs/README.md
          echo "- âœ… Clean: $summary_good" >> configs/README.md
          echo "- ðŸš« Proxy: $summary_proxy" >> configs/README.md
          echo "- âŒ Failed Connections: $summary_failed" >> configs/README.md

          # Move good back
          mv configs/checked/* configs/ || true
          rmdir configs/checked || true

      - name: ðŸš€ Commit updated README + JSON + moved configs
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add configs/
          git commit -m "âœ¨ Ultra VPN report: $(date '+%Y-%m-%d %H:%M:%S')"
          git push
        continue-on-error: true
